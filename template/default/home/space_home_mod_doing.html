<!--{if $space[self] && helper_access::check_module('doing')}-->
    <!--{template home/space_route_mod_doing_deliverer}-->
<!--{/if}-->

<!--{if $dolist}-->
	<!--{if $pricount}-->
		<p class="alert hi-warning" style="margin: 0 0 0 -15px; width: calc(100% + 30px);">{lang hide_doing}</p>
	<!--{/if}-->
    <ul class="timeline">
        <!--{eval $doday = '';}-->
        <!--{eval $domin = '';}-->
        <!--{loop $dolist $dv}-->
            <!--{eval $dodayN = date('ymd',$dv['dateline']);}-->
            <!--{eval $dominN = date('ymdi',$dv['dateline']);}-->
            <!--{eval $doid = $dv[doid];}-->
            <!--{eval $_GET[key] = $key = random(8);}-->
            <li class="node {if $doday != $dodayN}dayMark{/if}" id="{$key}dl{$doid}" {if checkperm('managedoing')}title="IP: $dv[ip]"{/if}>
                <div class="n-left">
                    <!--{if $doday != $dodayN}-->
                        <!--{eval $doday = $dodayN;}-->
                        <i class="time-A"><!--{date($dv['dateline'],'Y/m/d')}--></i>
                    <!--{/if}-->
                    <!--{if $domin != $dominN}-->
                        <!--{eval $domin = $dominN;}-->
                        <i class="time-B"><!--{date($dv['dateline'],'H:i')}--></i>
                        <div class="user-tag">
                            <a class="avatar" href="home.php?mod=space&uid=$dv[uid]" c="1"><!--{avatar($dv['uid'],'small')}--></a>
                            <a class="username" href="home.php?mod=space&uid=$dv[uid]">$dv[username]</a>
                        </div>
                    <!--{/if}-->
                </div>
                <div class="n-right">
                    <div class="s-top">
                        <i class="title">{lang update_doing}</i>
                        <!--{if $dv[status] == 1}--><i class="censor">{lang moderate_need}</i><!--{/if}-->
                        <!--{if $dv[uid]==$_G[uid]}-->
                        <div class="tool r">
                            <b class="dots"><i class="dot"></i><i class="dot"></i><i class="dot"></i></b>
                            <span class="tooltip lt" data-ignore='1'>
                                <a href="home.php?mod=spacecp&ac=doing&op=delete&doid=$doid&id=$dv[id]&handlekey=doinghk_{$doid}_$dv[id]" id="{$key}_doing_delete_{$doid}_{$dv[id]}" onclick="showWindow(this.id, this.href, 'get', 0);">{lang delete}</a>
                            </span>
                        </div>
                        <!--{/if}-->
                    </div>
                    <div class="s-center">
                        <div class="message">$dv[message]</div>
                        <div class="flow-comment-list">
                            <!--{eval $list = $clist[$doid];}-->
                            <div id="{$key}_$doid">
                                <div id="{$key}_form_{$doid}_0"></div>
                                <!--{if $clist[$doid]}-->
                                    <!--{template home/space_route_mod_doing_comments}-->
                                <!--{/if}-->
                            </div>
                        </div>
                    </div>
                    <div class="s-end">
                        <!--{if helper_access::check_module('doing')}-->
                        <a class="icon reply mt-textsms" onclick="docomment_form($doid, 0, '$key');"></a>
                        <!--{/if}-->
                    </div>

                </div>
            </li>
        <!--{/loop}-->
    </ul>
    <div class="page" id="pager_doing">
        <!--{if $multi}-->
            $multi
        <!--{elseif $_GET[highlight]}-->
            <a class="viewmore" href="home.php?mod=space&do=doing&view=me">{lang viewmore}</a>
        <!--{else}-->
            <p class="nomore">{lang nomore}</p>
        <!--{/if}-->
    </div>
<!--{else}-->
    <ul class="timeline">
        <li class="node">
        <div class="n-left">
            <i class="time-A">? / ? / ?</i>
            <i class="time-B">? : ?</i>
            <div class="user-tag">
                <a class="avatar"><!--{avatar(0,'small')}--></a>
                <a class="username">————</a>
            </div>
        </div>
        <div class="n-right">
            <div class="s-top">
                <i class="title">{lang nomore}</i>
            </div>
            <div class="s-center">
                <div class="message">{lang global_nothing}</div>
            </div>
        </div>
        </li>
    </ul>
    <div class="page" id="pager_doing">
        <p class="nomore">{lang nomore}</p>
    </div>
<!--{/if}-->
<script>
    addEvent(document,'DOMContentLoaded',function () {

        let postform = SR('#doing_deliver')[0],
            page = SR('#pager_doing')[0],
            scrltem = 0,
            positionfix = function (){
                if(SRGlobal.Window.Width <= 1680){
                    postform.style = '';
                    if(SRGlobal.Window.Scroll.DirY === 'down'){
                        scrltem = SRGlobal.Window.Scroll.Top;
                        if(page) page.addClass('sleep');
                        if(postform) postform.addClass('sleep');
                    } else if(scrltem - SRGlobal.Window.Scroll.Top > Math.min(390, MasElements.viewer.scrollHeight - SRGlobal.Window.Height - 20)) {
                        if(page) page.delClass('sleep');
                        if(postform) postform.delClass('sleep');
                    }
                }
            },

            Tl = SR('.timeline')[0],
            Ts = SR('.time-A'),
            Th = Ts[0].Css.height,
            TsOn = function (){
                for (let i=0 ; i <Ts.length; i++){
                    if(Ts[i].parentNode.Css.top < 82 && (isUndefined(Ts[i+1]) || Ts[i+1].parentNode.Css.top > 82)){
                        Ts[i].style = 'position: fixed; top: 82px;';
                        Ts[i].parentNode.style = 'padding-top:' + Th + 'px;';
                    } else {
                        Ts[i].style = '';
                        Ts[i].parentNode.style = '';
                    }
                }
            };

        if(MasElements.viewer.scrollHeight > SRGlobal.Window.Height){
            if(page) page.addClass('sleep');
            if(postform) postform.addClass('sleep');
        } else {
            Tl.style.marginBottom = '200px';
        }
        addEvent(MasElements.viewer,'scroll',TsOn);
        addEvent(MasElements.viewer,'scroll',positionfix);
    });
</script>
